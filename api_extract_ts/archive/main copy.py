app = Flask(__name__)

import os
import json
from extract_ts import extract
from flask import Flask,request, make_response

@app.route('/phenologic_methods',methods=['GET'])
def methods():

    payload = {
        "methods": [
            {
                "id": "0",
                "name": "TIMESAT 3.1"
            },
            {
                "id": "1",
                "name": "Change Detection Derivate"
            },
            {
                "id": "2",
                "name": "Sen2-Agri Vegetation Status"
            },
            {
                "id": "3",
                "name": "Greenbrown"
            },
            {
                "id": "4",
                "name": "CropPhenology"
            },
            {
                "id": "5",
                "name": "Phenofit"
            },

        ] 
    }

    res = make_response(payload)
    res.headers['Content-Type'] = 'application/json'

    return res

# http://192.168.15.9:8080/phenologic_metrics?method=0&cube=S2-recent_10_16D_STK-1&period={"start": "2019-01", "end": "2020-01-01"}&area={"type": "Polygon", "coordinates": [[[-42.0968627929688, -19.6478313116844], [-42.3028564453125, -19.6477609556974], [-42.3028564453125, -19.8984718033807], [-42.3014831542969, -19.8984710238534], [-42.0968627929688, -19.8984710238534], [-42.0968627929688, -19.6478313116844]]]}
@app.route('/phenologic_metrics',methods=['GET'])
def metrics():

    area    = json.loads(request.args.get("area"))
    period  = request.args.get("period")
    cube    = request.args.get("cube")
    token   = request.args.get("token")

    payload = {
            "method": "Change Detection Derivate", 
            "area": {"type": "Polygon", "coordinates": [[[-42.0968627929688, -19.6478313116844], [-42.3028564453125, -19.6477609556974], [-42.3028564453125, -19.8984718033807], [-42.3014831542969, -19.8984710238534], [-42.0968627929688, -19.8984710238534], [-42.0968627929688, -19.6478313116844]]]},
            "datacube": "S2-recent_10_16D_STK-1",
            "period": {
                "start": "2019-01-01",
                "end": "2020-01-01"
            },
            "source": "https://brazildatacube.dpi.inpe.br/",
            "service": "wtss 0.7.0.post3",
            "index": {
                "ndvi": {
                    "raw": {
                        "value": [
                            0.2216972472136608,
                            0.23126505426112987,
                            0.2554715359779549,
                            0.21193363625020226,
                            0.22140340665867053,
                            0.22167711788334862,
                            0.2157992547781603,
                            0.22733206422289287,
                            0.24498886414254542,
                            0.2490125661271753,
                            0.21412917240748314,
                            0.21142655334212312,
                            0.21388277172644124,
                            0.24282644419163013,
                            0.2000921490823963,
                            0.2202078876977612,
                            0.14653554523733872,
                            0.2614874467077214,
                            0.26264186417038465,
                            0.20905885916716768,
                            0.21193385538556778,
                            0.2428660531804797,
                            0.24464831804281345,
                            0.2549650142728679,
                            0.2143635356904366,
                            0.23486063848715677,
                            0.4771962044689561,
                            0.21854602745892415,
                            0.23125740450191012,
                            0.32015810276679774,
                            0.25282606668538177,
                            0.32186509732908924,
                            0.25861660033304185,
                            0.2060434305893348,
                            0.2558139534883716,
                            0.2399143359720992,
                            0.45454545454548745,
                            0.2763622986150324,
                            0.11932221458368643,
                            0.3361753958587002,
                            0.29396861455039325,
                            0.13080488475741534,
                            0.40965316517099376,
                            0.26459817976032896,
                            0.26259045798283637,
                            0.2201008095310829,
                            0.08871627146361406,
                            0.21687173492167686,
                            0.5428438010740138,
                            0.32148199637765584,
                            0.4437869822485207,
                            0.5519495154383252,
                            0.3025874406270244,
                            0.4204337471163736,
                            0.46608946608946566,
                            0.4082787867882296,
                            0.5712383488681585,
                            0.49493345432546604,
                            0.19042402595923424,
                            0.5788267644362967,
                            0.6510449392671084,
                            0.8064123376623349,
                            0.49032479939743767,
                            0.8876448634845859,
                            0.900325394542523,
                            0.8392124692370797,
                            0.8780333348482153,
                            0.7271609995904273,
                            0.7641041369587886,
                            0.8740286056917671,
                            0.9004119813499643,
                            0.9162323157111094,
                            0.7844905583057175,
                            0.9355590455842326,
                            0.9072152803826157,
                            0.5013567438148534,
                            0.8964413342436316,
                            0.8731345896781231,
                            0.9155264723379454,
                            0.9205728751987935,
                            0.2820018841438689,
                            0.92127056318786,
                            0.813931067727191,
                            0.8932316491897023,
                            0.7431540613544931,
                            0.5551601423487668,
                            0.5345251838884244,
                            0.36445263642719106,
                            0.788659793814433,
                            0.5412223667100252,
                            0.307276227796122,
                            0.4316884860691506,
                            0.3769617284366629,
                            0.3738449444813969,
                            0.26463757035965996,
                            0.3425076452599383,
                            0.4795070220693566,
                            0.19723072319686816,
                            0.2918747937066785,
                            0.2846282732843997,
                            0.2439967576817353,
                            0.3561960866820792,
                            0.36793932272193336,
                            0.26589498406307666,
                            0.5658014022474143,
                            0.6396719774792575,
                            0.4394742413392809,
                            0.8143248175182891,
                            0.7620974652689431,
                            0.8342803169882821,
                            0.8418424572303855,
                            0.6769301470588118,
                            0.36116959787794267,
                            0.7137792910015319,
                            0.7544331004835954,
                            0.7193766291595564,
                            0.7481388381337057,
                            0.7643623025593898,
                            0.6486137975499878,
                            0.719444175253846,
                            0.7246695047260899,
                            0.6947230353768511,
                            0.7063170513987116,
                            0.6858789625359948,
                            0.7051084338282907,
                            0.7284403669724778,
                            0.6582126930160035,
                            0.7209016014958157,
                            0.6399383191981258,
                            0.6348435183301832,
                            0.6466165413533828,
                            0.6377452857804612,
                            0.6309304941813072,
                            0.530463038180374,
                            0.5839938827095532,
                            0.5957193798087161,
                            0.6059683522461683,
                            0.516500994035794,
                            0.5448758991552899,
                            0.5496415966763903,
                            0.523306643265581,
                            0.539915488886057,
                            0.5058570676581666,
                            0.43274161735696276,
                            0.4823873675472262,
                            0.4885324584677254,
                            0.49039947727773864,
                            0.4433111748247389,
                            0.3891934220830157,
                            0.45060283434903814,
                            0.4277165142139897,
                            0.4024013722126752,
                            0.4082107264904214,
                            0.42656720614165833,
                            0.3965296339593008,
                            0.36626676076214565,
                            0.33002351540134484,
                            0.3252716246412097,
                            0.341372912801489,
                            0.3221887252341329,
                            0.3143747314073611,
                            0.3306930693069136,
                            0.31057244733220557,
                            0.30807771059336375,
                            0.3035509736540498,
                            0.3290164820671767,
                            0.2998062224885198,
                            0.3088448525857902,
                            0.29590940325340453,
                            0.2917903765168288,
                            0.2939603648116489,
                            0.2876712328767231
                        ],
                        "date": [
                            "2019-09-02",
                            "2019-09-03",
                            "2019-09-06",
                            "2019-09-07",
                            "2019-09-08",
                            "2019-09-08",
                            "2019-09-12",
                            "2019-09-12",
                            "2019-09-14",
                            "2019-09-16",
                            "2019-09-17",
                            "2019-09-17",
                            "2019-09-22",
                            "2019-09-22",
                            "2019-09-24",
                            "2019-09-26",
                            "2019-09-27",
                            "2019-09-30",
                            "2019-10-02",
                            "2019-10-02",
                            "2019-10-07",
                            "2019-10-08",
                            "2019-10-09",
                            "2019-10-10",
                            "2019-10-12",
                            "2019-10-14",
                            "2019-10-16",
                            "2019-10-17",
                            "2019-10-18",
                            "2019-10-18",
                            "2019-10-23",
                            "2019-10-24",
                            "2019-10-26",
                            "2019-10-27",
                            "2019-10-27",
                            "2019-11-01",
                            "2019-11-01",
                            "2019-11-03",
                            "2019-11-06",
                            "2019-11-09",
                            "2019-11-11",
                            "2019-11-11",
                            "2019-11-17",
                            "2019-11-19",
                            "2019-11-19",
                            "2019-11-25",
                            "2019-11-26",
                            "2019-12-01",
                            "2019-12-03",
                            "2019-12-05",
                            "2019-12-07",
                            "2019-12-11",
                            "2019-12-11",
                            "2019-12-12",
                            "2019-12-16",
                            "2019-12-16",
                            "2019-12-19",
                            "2019-12-21",
                            "2019-12-26",
                            "2019-12-27",
                            "2019-12-29",
                            "2020-01-01",
                            "2020-01-05",
                            "2020-01-09",
                            "2020-01-10",
                            "2020-01-12",
                            "2020-01-14",
                            "2020-01-17",
                            "2020-01-20",
                            "2020-01-22",
                            "2020-01-25",
                            "2020-01-25",
                            "2020-01-26",
                            "2020-01-30",
                            "2020-01-30",
                            "2020-02-02",
                            "2020-02-07",
                            "2020-02-09",
                            "2020-02-10",
                            "2020-02-13",
                            "2020-02-14",
                            "2020-02-18",
                            "2020-02-18",
                            "2020-02-22",
                            "2020-02-24",
                            "2020-02-26",
                            "2020-03-02",
                            "2020-03-05",
                            "2020-03-11",
                            "2020-03-13",
                            "2020-03-18",
                            "2020-03-21",
                            "2020-03-25",
                            "2020-03-25",
                            "2020-03-26",
                            "2020-03-29",
                            "2020-03-29",
                            "2020-03-30",
                            "2020-04-03",
                            "2020-04-03",
                            "2020-04-04",
                            "2020-04-06",
                            "2020-04-07",
                            "2020-04-11",
                            "2020-04-14",
                            "2020-04-19",
                            "2020-04-19",
                            "2020-04-22",
                            "2020-04-24",
                            "2020-04-27",
                            "2020-04-29",
                            "2020-04-30",
                            "2020-05-04",
                            "2020-05-05",
                            "2020-05-08",
                            "2020-05-13",
                            "2020-05-14",
                            "2020-05-14",
                            "2020-05-16",
                            "2020-05-18",
                            "2020-05-19",
                            "2020-05-21",
                            "2020-05-23",
                            "2020-05-24",
                            "2020-05-24",
                            "2020-05-27",
                            "2020-05-29",
                            "2020-05-29",
                            "2020-06-01",
                            "2020-06-03",
                            "2020-06-05",
                            "2020-06-06",
                            "2020-06-08",
                            "2020-06-09",
                            "2020-06-13",
                            "2020-06-14",
                            "2020-06-14",
                            "2020-06-17",
                            "2020-06-18",
                            "2020-06-19",
                            "2020-06-22",
                            "2020-06-23",
                            "2020-06-23",
                            "2020-06-25",
                            "2020-06-28",
                            "2020-06-28",
                            "2020-06-30",
                            "2020-07-03",
                            "2020-07-03",
                            "2020-07-08",
                            "2020-07-08",
                            "2020-07-11",
                            "2020-07-13",
                            "2020-07-16",
                            "2020-07-18",
                            "2020-07-19",
                            "2020-07-23",
                            "2020-07-24",
                            "2020-07-27",
                            "2020-07-28",
                            "2020-08-02",
                            "2020-08-04",
                            "2020-08-07",
                            "2020-08-09",
                            "2020-08-12",
                            "2020-08-17",
                            "2020-08-17",
                            "2020-08-20",
                            "2020-08-22",
                            "2020-08-25",
                            "2020-08-27",
                            "2020-08-28"
                        ]
                    },
                    "processed": {
                        "value": [
                            0.2216972472136608,
                            0.23126505426112987,
                            0.2554715359779549,
                            0.21193363625020226,
                            0.22140340665867053,
                            0.22167711788334862,
                            0.2157992547781603,
                            0.22733206422289287,
                            0.24498886414254542,
                            0.2490125661271753,
                            0.21412917240748314,
                            0.21142655334212312,
                            0.21388277172644124,
                            0.24282644419163013,
                            0.2000921490823963,
                            0.2202078876977612,
                            0.14653554523733872,
                            0.2614874467077214,
                            0.26264186417038465,
                            0.20905885916716768,
                            0.21193385538556778,
                            0.2428660531804797,
                            0.24464831804281345,
                            0.2549650142728679,
                            0.2143635356904366,
                            0.23486063848715677,
                            0.4771962044689561,
                            0.21854602745892415,
                            0.23125740450191012,
                            0.32015810276679774,
                            0.25282606668538177,
                            0.32186509732908924,
                            0.25861660033304185,
                            0.2060434305893348,
                            0.2558139534883716,
                            0.2399143359720992,
                            0.45454545454548745,
                            0.2763622986150324,
                            0.11932221458368643,
                            0.3361753958587002,
                            0.29396861455039325,
                            0.13080488475741534,
                            0.40965316517099376,
                            0.26459817976032896,
                            0.26259045798283637,
                            0.2201008095310829,
                            0.08871627146361406,
                            0.21687173492167686,
                            0.5428438010740138,
                            0.32148199637765584,
                            0.4437869822485207,
                            0.5519495154383252,
                            0.3025874406270244,
                            0.4204337471163736,
                            0.46608946608946566,
                            0.4082787867882296,
                            0.5712383488681585,
                            0.49493345432546604,
                            0.19042402595923424,
                            0.5788267644362967,
                            0.6510449392671084,
                            0.8064123376623349,
                            0.49032479939743767,
                            0.8876448634845859,
                            0.900325394542523,
                            0.8392124692370797,
                            0.8780333348482153,
                            0.7271609995904273,
                            0.7641041369587886,
                            0.8740286056917671,
                            0.9004119813499643,
                            0.9162323157111094,
                            0.7844905583057175,
                            0.9355590455842326,
                            0.9072152803826157,
                            0.5013567438148534,
                            0.8964413342436316,
                            0.8731345896781231,
                            0.9155264723379454,
                            0.9205728751987935,
                            0.2820018841438689,
                            0.92127056318786,
                            0.813931067727191,
                            0.8932316491897023,
                            0.7431540613544931,
                            0.5551601423487668,
                            0.5345251838884244,
                            0.36445263642719106,
                            0.788659793814433,
                            0.5412223667100252,
                            0.307276227796122,
                            0.4316884860691506,
                            0.3769617284366629,
                            0.3738449444813969,
                            0.26463757035965996,
                            0.3425076452599383,
                            0.4795070220693566,
                            0.19723072319686816,
                            0.2918747937066785,
                            0.2846282732843997,
                            0.2439967576817353,
                            0.3561960866820792,
                            0.36793932272193336,
                            0.26589498406307666,
                            0.5658014022474143,
                            0.6396719774792575,
                            0.4394742413392809,
                            0.8143248175182891,
                            0.7620974652689431,
                            0.8342803169882821,
                            0.8418424572303855,
                            0.6769301470588118,
                            0.36116959787794267,
                            0.7137792910015319,
                            0.7544331004835954,
                            0.7193766291595564,
                            0.7481388381337057,
                            0.7643623025593898,
                            0.6486137975499878,
                            0.719444175253846,
                            0.7246695047260899,
                            0.6947230353768511,
                            0.7063170513987116,
                            0.6858789625359948,
                            0.7051084338282907,
                            0.7284403669724778,
                            0.6582126930160035,
                            0.7209016014958157,
                            0.6399383191981258,
                            0.6348435183301832,
                            0.6466165413533828,
                            0.6377452857804612,
                            0.6309304941813072,
                            0.530463038180374,
                            0.5839938827095532,
                            0.5957193798087161,
                            0.6059683522461683,
                            0.516500994035794,
                            0.5448758991552899,
                            0.5496415966763903,
                            0.523306643265581,
                            0.539915488886057,
                            0.5058570676581666,
                            0.43274161735696276,
                            0.4823873675472262,
                            0.4885324584677254,
                            0.49039947727773864,
                            0.4433111748247389,
                            0.3891934220830157,
                            0.45060283434903814,
                            0.4277165142139897,
                            0.4024013722126752,
                            0.4082107264904214,
                            0.42656720614165833,
                            0.3965296339593008,
                            0.36626676076214565,
                            0.33002351540134484,
                            0.3252716246412097,
                            0.341372912801489,
                            0.3221887252341329,
                            0.3143747314073611,
                            0.3306930693069136,
                            0.31057244733220557,
                            0.30807771059336375,
                            0.3035509736540498,
                            0.3290164820671767,
                            0.2998062224885198,
                            0.3088448525857902,
                            0.29590940325340453,
                            0.2917903765168288,
                            0.2939603648116489,
                            0.2876712328767231
                        ],
                        "date": [
                            "2019-09-02",
                            "2019-09-03",
                            "2019-09-06",
                            "2019-09-07",
                            "2019-09-08",
                            "2019-09-08",
                            "2019-09-12",
                            "2019-09-12",
                            "2019-09-14",
                            "2019-09-16",
                            "2019-09-17",
                            "2019-09-17",
                            "2019-09-22",
                            "2019-09-22",
                            "2019-09-24",
                            "2019-09-26",
                            "2019-09-27",
                            "2019-09-30",
                            "2019-10-02",
                            "2019-10-02",
                            "2019-10-07",
                            "2019-10-08",
                            "2019-10-09",
                            "2019-10-10",
                            "2019-10-12",
                            "2019-10-14",
                            "2019-10-16",
                            "2019-10-17",
                            "2019-10-18",
                            "2019-10-18",
                            "2019-10-23",
                            "2019-10-24",
                            "2019-10-26",
                            "2019-10-27",
                            "2019-10-27",
                            "2019-11-01",
                            "2019-11-01",
                            "2019-11-03",
                            "2019-11-06",
                            "2019-11-09",
                            "2019-11-11",
                            "2019-11-11",
                            "2019-11-17",
                            "2019-11-19",
                            "2019-11-19",
                            "2019-11-25",
                            "2019-11-26",
                            "2019-12-01",
                            "2019-12-03",
                            "2019-12-05",
                            "2019-12-07",
                            "2019-12-11",
                            "2019-12-11",
                            "2019-12-12",
                            "2019-12-16",
                            "2019-12-16",
                            "2019-12-19",
                            "2019-12-21",
                            "2019-12-26",
                            "2019-12-27",
                            "2019-12-29",
                            "2020-01-01",
                            "2020-01-05",
                            "2020-01-09",
                            "2020-01-10",
                            "2020-01-12",
                            "2020-01-14",
                            "2020-01-17",
                            "2020-01-20",
                            "2020-01-22",
                            "2020-01-25",
                            "2020-01-25",
                            "2020-01-26",
                            "2020-01-30",
                            "2020-01-30",
                            "2020-02-02",
                            "2020-02-07",
                            "2020-02-09",
                            "2020-02-10",
                            "2020-02-13",
                            "2020-02-14",
                            "2020-02-18",
                            "2020-02-18",
                            "2020-02-22",
                            "2020-02-24",
                            "2020-02-26",
                            "2020-03-02",
                            "2020-03-05",
                            "2020-03-11",
                            "2020-03-13",
                            "2020-03-18",
                            "2020-03-21",
                            "2020-03-25",
                            "2020-03-25",
                            "2020-03-26",
                            "2020-03-29",
                            "2020-03-29",
                            "2020-03-30",
                            "2020-04-03",
                            "2020-04-03",
                            "2020-04-04",
                            "2020-04-06",
                            "2020-04-07",
                            "2020-04-11",
                            "2020-04-14",
                            "2020-04-19",
                            "2020-04-19",
                            "2020-04-22",
                            "2020-04-24",
                            "2020-04-27",
                            "2020-04-29",
                            "2020-04-30",
                            "2020-05-04",
                            "2020-05-05",
                            "2020-05-08",
                            "2020-05-13",
                            "2020-05-14",
                            "2020-05-14",
                            "2020-05-16",
                            "2020-05-18",
                            "2020-05-19",
                            "2020-05-21",
                            "2020-05-23",
                            "2020-05-24",
                            "2020-05-24",
                            "2020-05-27",
                            "2020-05-29",
                            "2020-05-29",
                            "2020-06-01",
                            "2020-06-03",
                            "2020-06-05",
                            "2020-06-06",
                            "2020-06-08",
                            "2020-06-09",
                            "2020-06-13",
                            "2020-06-14",
                            "2020-06-14",
                            "2020-06-17",
                            "2020-06-18",
                            "2020-06-19",
                            "2020-06-22",
                            "2020-06-23",
                            "2020-06-23",
                            "2020-06-25",
                            "2020-06-28",
                            "2020-06-28",
                            "2020-06-30",
                            "2020-07-03",
                            "2020-07-03",
                            "2020-07-08",
                            "2020-07-08",
                            "2020-07-11",
                            "2020-07-13",
                            "2020-07-16",
                            "2020-07-18",
                            "2020-07-19",
                            "2020-07-23",
                            "2020-07-24",
                            "2020-07-27",
                            "2020-07-28",
                            "2020-08-02",
                            "2020-08-04",
                            "2020-08-07",
                            "2020-08-09",
                            "2020-08-12",
                            "2020-08-17",
                            "2020-08-17",
                            "2020-08-20",
                            "2020-08-22",
                            "2020-08-25",
                            "2020-08-27",
                            "2020-08-28"
                        ]
                    }
                }
            },
            "metrics": {
                "phenologic": {
                    "stages": [ 
                        { 
                            "SOS": "2020-01-01",  
                            "PEAK": "2020-01-01", 
                            "EOS": "2020-01-01",  
                            "LOS": "2020-01-01"   
                        }
                    ]
                },
                "mean_square_error": 0.053,
                "statistics": {
                    "Minimum": 0.197,
                    "Maximum": 0.842,
                    "average": 0.523,
                    "median": 0.52,
                    "deviation": 0.17
                }
            }
        }

    ## Extrair e montar serie
    # extract(area, token, datacube, n_points)
    extract(area)

    # Request para a API do Plumber

    # vai ter que ter volume no docker ou estudar como mandar csv post plumber


    res = make_response(payload)
    res.headers['Content-Type'] = 'application/json'

    return res

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0',port=int(os.environ.get("PORT", 8080)))


# Metodo para listar os cubos de dados
# Describe do cubo 

# parametro token de acesso BDC